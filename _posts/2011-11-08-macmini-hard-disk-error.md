---
layout: post
title:  "Mac Mini 하드 디스크 이상"
date:   2011-11-08 15:56:00
categories: [mac]
tags: [mac, macosx]
---

Mac Mini Server Snow Leopard를 쓰고 있었다. 500기가 하드 디스크가 두 개 달려있었는데 RAID를 잡지 않고 별개 디스크로 쓰고 있었다. 두번째 하드는 500기가 그대로 하나의 파티션으로 두고 사실상 거의 쓰지 않았고 첫번째 하드는 파티션을 나누어 시스템 설치에 120기가, 나머지는 자료 보관용으로 쓰고 있었다. 그냥 RAID1을 잡자니 아깝다는 생각도 들고 평소에 자료를 따로 보관하면 되지 않겠냐는 생각이었다. 타임머신도 써본 적도 없고 그냥 믿음이 별로 없어서 아예 써볼 생각도 하지 않았다. 그런데 평소에 백업은 하지 않아 불안한 마음이 항상 마음 한켠에 자리 잡고 있었던 어느 날이었다.

갑자기 모든 것이 너무 느리게 반응하기 시작했다. 이상하다 싶어서 재부팅을 했더니 괜찮았는데. 조금 쓰다보니 이제는 정말 거의 얼었다 잠깐 작동했다 하는 식으로 반응하기 시작했다. CPU 점유율을 체크해보니 그다지 높지도 않고 SSH로 외부에서 접속을 시도해 봐도 무반응이었다. 결국 강제로 전원을 내리고 다시 부팅하려는데 이제는 회색 사과 로고에 톱니만 한없이 돌고 켜지지 않는다.

각종 재설정을 해보았지만 똑같다.

- 참조: http://support.apple.com/kb/ht1379

부팅할 때 Command + V를 눌러서 메시지를 보니 하드 디스크를 못 읽는다.

- 참조: http://support.apple.com/kb/HT1533

SuperDrive를 연결하고 설치 DVD를 넣고 C를 누르면서 부팅하면 DVD로 부팅이 된다. Disk Utility를 실행 시켜서 디스크 검사를 하니 시스템 파티션에서 에러가 나고 데이터가 있는 디스크들은 말짱하다. Repair를 했더니 잘 진행되고 잘 고쳐졌다는 메시지가 나온다. 안도하면서 재부팅을 했는데 여전히 이전과 마찬가지로 톱니만 한없이 돈다. 아무리 기다려도 소용이 없다.

다시 설치 DVD로 부팅하여 디스크 유틸리티로 확인해 보니 똑같은 에러가 난다. 다시 Repair를 하니 또 잘 고쳐졌단다. 이것을 몇번 반복했지만 여전히 소용이 없었다. DVD 부팅하는데 시간 정말 오래 걸린다.

#### 디스크 유틸리티의 Restore를 이용한 백업

일단 안 되겠다 싶어 데이터를 백업하기로 했다. 자료들 모아놓은 파티션에는 200기가 정도 데이터가 있었는데 외장 USB 하드 디스크 연결하고 Disk Utility의 Restore 기능을 이용해서 완벽하게 백업이 되었다. 시스템 파티션도 Restore로  다른 외장 USB 하드에 백업하려고 해보았는데 중간에서 에러가 난다. 하드 디스크에 문제가 생긴 게 틀림없다.

#### Terminal에서 복사

홈 디렉토리에도 필요한 자료가 꽤 있다. 설치 DVD로 부팅한 상태에서 Terminal.app도 실행가능하다. 외장 하드 연결하고 필요한 파일과 디렉토리들을 하나씩 외장 하드에 복사하기 시작했다. 홈 디렉토리를 통째로 복사하는 것도 실패했다. 에러가 난다. 결국 몇개 디렉토리는 복사가 안 되는 것을 확인했는데 다행히 그 디렉토리들은 필요없는 것이었다.

#### SFTP 접속

설치 DVD로 부팅한 상태에서 외부에서 SSH로 접속하는 것도 가능하다. 외장 USB 하드가 없지만 네트워크에 연결되어 있을 때는 다른 컴퓨터에서 SFTP 클라이언트로 접속해서 필요한 파일을 백업할 수도 있다. 이때 계정은 root, 암호는 Mac Mini 본체 뒷판에 조그맣게 써있는 시리얼 넘버의 첫 8글자이다. 대소문자 구별해야한다.

#### 하드 디스크의 물리적인 오류?

 이제 데이터 백업은 다 했으니 한시름 놓았다. 이제 재설치를 할까 서비스센터에 갈까 고민이 되었다. 하드 디스크 물리적인 오류라면 재설치가 의미가 없고 물리적인 문제가 아니라면 바쁜데 서비스센터에 가는 것은 엄청난 시간 낭비다. 일단 애플에 전화를 해보았다. 맥 미니 서버라니 일단 잘은 모르겠단다. 한국에서는 맥 미니 "서버"는 서비스가 안 된다고. 확신은 없지만 맥 미니 기준으로 상담해 주겠단다.

일단 중요한 데이터 백업은 다 되었다고 하니 재설치를 권장한다. 증상을 얘기하고 하드 디스크 물리적이 오류일 것 같다고 하니 확신할 수 없단다. 뭔가 꼬여서 그런 일이 일어나기도 한단다. 서비스센터에 가지고 와도 좋고 애플 케어 가입되어 있으니 요청하면 방문해서 가져간단다. 하지만 멀쩡한데 시간 낭비가 될 수도 있으니 재설치 한번 해보란다.

하드 디스크 오류 체크하는 기능이 없냐고 물어 보니, 맥 미니 서버는 어떤지 확신이 없지만 그런 기능이 있기는 있다고 한다. 설치 DVD를 넣고 D를 누르고 부팅하면 된다나 그렇단다. 하지만 별로 권장하고 싶지 않은 모양이다. 시간이 엄청 걸린단다. 1시간 넘게 걸린다고 한다. 어차피 재설치하면, 만약에 하드 디스크에 문제가 있다면, 재설치하다가 실패할 것이란다. 잘 설치되면 괜찮은 것이니 그냥 쓰고 실패하면 서비스 맡기고. 그러는 것이 좋을 것이란다.


#### RAID에 설치

이제 한번 당하고 나니 RAID를 쓸 마음이 생겼다. 일단 RAID1 잡고 설치했다. RAID 잡는 건 너무 쉬워서 허탈할 정도로 간단하다. 재설치는 잘 되었다. 하드 디스크 물리적 오류는 없는 모양이다.

파티션 나누기도 하지 않았다. 그 동안 너무 복잡하게 살았다. 그냥 생각없이 써야겠다. RAID로 쓰다가 하나 고장나서 메시지 뜨면 외장 하드에 일단 그대로 백업 떠놓고 애플 서비스 센터가서 새 하드로 바꿔 달아오면 끝이다.

iMac도 있는데 타임머신 쓰는 것을 심각하게 고민해봐야겠다.


#### 결국 서비스 센터
[업데이트 2011-12-20]

재설치 후 한달 넘게 잘 사용했는데 결국 하드 디스크에 물리적 오류가 있었던 모양이다. RAID1을 잡아놓기를 정말 잘 했다. 디스크 하나가 오류가 나고 RADI가 저하(degraded)되었다. 느낌이 좀 이상해서 디스크 유틸리티를 열어 보았는데 하드 디스크가 주황색으로 나타난 것을 보고 알았다. 메시지로 알려주는 기능은 없나보다.

맥 미니 서버를 산지 정확하게 1년이 되는 날이었다. 애플 케어에 가입되어있기 때문에 3년가 서비스가 되니 걱정은 없다. 애플 제품은 반드시 애플 케어를 사야한다. 그게 속 편하다.

일단 백업을 떴다. RAID1이라 일단 컴퓨터 작동하는 데에는 아무런 문제도 없다. USB 외장하드 500G 짜리가 하나 안 쓰는 것이 있었다. 디스크 유틸리티에서 복원 기능을 이용해 백업을 떴다. 6시간 걸렸다. 하드 망가진 것만 교체해서 넣으면 원래대로 된다지만 RAID1에서 하드 교체하다가 실수로 잘못 세팅해서 다 날려먹었다는 소리 종종 들었다. 그리고 서비스 센터에서 무슨 일이 일어날지 알게 뭔가. 무조건 백업은 하고 본다.

서비스 센터에 맡겼다. 담당자가 하드 디스크만 교체하면 되는 것이니 문제가 복잡하지는 않다고 안심을 시킨다. 서비스에 일반적으로 3-4일이 걸린다고 한다.

애플 케어에 가입이 되어있다면 픽업 서비스가 가능하다고 한다. 전화 걸면 집으로 와서 가져가서 고쳐서 다시 집으로 가져다 주는 서비스이다. 다음에 문제가 생기면 픽업 서비스를 받아야겠다. 서비스 센터 왔다갔다 하는 것도 귀찮다.



#### RAID1 원상 복구
[업데이트 2011-12-28]

하드 디스크 교체 서비스 받는데 일주일 걸렸다. 원래는 3-4일이면 되는데 서비스 센터가 이전하느라고 시스템이 정리가 안 돼서 오래 걸렸단다. 하드 디스크 새 것을 갈아 끼우기만 한 상태에서 돌려주었다.

원상 복구하는 데 꽤 헤맸다.

부팅하자 처음에 평소보다 시간이 꽤 걸렸다. 문제인가 했는데 잠시 기다리니 정상적으로 부팅되었다. 로그인하고 디스크 유틸리티를 열어보니 전에 망가졌었던 RAID 슬라이스가 "유실됨"으로 나온다. 영어로는 "missing"이라고 나온단다. 새로 장착한 디스크를 드래그해서  "미러러링된 RAID 세트" 아래 목록에 넣고 "재형성" (영어로는 rebuild) 버튼을 누르면 모든 일이 끝나야 하는데 이 버튼이 회색 상태로 나온다. 아무 것도 할 수가 없다. 한참 검색을 하다 답을 발견했다.

- 참조: https://discussions.apple.com/thread/3477349

커맨드 라인에서 해야 한단다. Terminal.app를 열고 다음처럼 써주면 된다. 물론 디스크 경로는 상황에 맞게 바꾸어 주어야 한다.

```
$ sudo diskutil appleRAID repairMirror /Volumes/ServerHD /dev/disk1
```

위에서 /Volumes/ServerHD 자리에는 RAID Mirrored Set로 묶어서 만들어진 결과물인 디스크의 경로를 써주어야한다. 그러니까 실제로 사용하는 디스크의 이름이다. /dev/disk1 자리에는 새로 추가한 디스크를 써준다. Mac mini Server에는 /dev/disk0와 /dev/disk1이 있다. 어느 디스크가 새로 추가한 것인지 알고 싶다면
$ diskutil list
로 확인해 보자. 

이제 디스크 유틸리티를 열어 보면 이전의 "유실된" 디스크는 사라지고 새로 추가된 디스크가 "미러링된 RAID 세트"의 목록에 나타나는 것을 볼 수 있다. 새로 추가된 RAID 슬라이스는 빨간색으로 표시되고 "실패"라는 메시지가 뜬다. 이제 "재형성" 버튼이 활성화된 것을 볼 수 있다. 재형성 버튼을 누르면 새 디스크에 복사가 시작된다.
